name: Bot Health Monitor

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  health-check:
    runs-on: ubuntu-latest
    steps:
    - name: Check Bot Status
      run: |
        echo "Checking bot health..."
        
        # Check if bot is responding (you'd need to implement a health endpoint)
        # curl -f ${{ secrets.BOT_HEALTH_URL }} || echo "Bot health check failed"
        
        # Check dashboard status
        curl -f ${{ secrets.DASHBOARD_URL }} || echo "Dashboard health check failed"
        
        # Check Discord API status
        curl -f https://discord.com/api/v10/gateway || echo "Discord API check failed"
        
        echo "Health check completed"
      
    - name: Send Discord Notification
      if: failure()
      run: |
        # Send notification to Discord webhook if health check fails
        curl -H "Content-Type: application/json" \
             -d '{"content":"ðŸš¨ Bot health check failed! Please investigate."}' \
             ${{ secrets.DISCORD_WEBHOOK_URL }}

  dependency-update:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Check for dependency updates
      run: |
        pip install pip-review
        pip-review --local --output=update-report.txt
        
        if [ -s update-report.txt ]; then
          echo "Dependencies need updating:"
          cat update-report.txt
          exit 1
        else
          echo "All dependencies are up to date"
        fi
    
    - name: Create Issue for Updates
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'Dependency Updates Available',
            body: 'The following dependencies need updating:\n\n```\n' + 
                  require('fs').readFileSync('update-report.txt', 'utf8') + 
                  '\n```\n\nPlease review and update dependencies as needed.',
            labels: ['dependencies', 'maintenance']
          }) 